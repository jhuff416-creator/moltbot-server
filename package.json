import express from "express";
import OpenAI from "openai";
import fs from "fs";

const app = express();
app.use(express.json());

// =====================
// ENV
// =====================
const { TELEGRAM_BOT_TOKEN, OPENAI_API_KEY, PORT = 8080 } = process.env;
const OPENAI_MODEL = (process.env.OPENAI_MODEL || "gpt-4o-mini").trim();

if (!TELEGRAM_BOT_TOKEN) throw new Error("Missing TELEGRAM_BOT_TOKEN");
if (!OPENAI_API_KEY) throw new Error("Missing OPENAI_API_KEY");

// =====================
// OPENAI CLIENT
// =====================
const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

// =====================
// MEMORY (LOCAL JSON FILE)
// =====================
const MEMORY_FILE = "./memory.json";

function loadAllMemory() {
  try {
    if (!fs.existsSync(MEMORY_FILE)) {
      fs.writeFileSync(MEMORY_FILE, "{}");
    }
    const raw = fs.readFileSync(MEMORY_FILE, "utf-8");
    return JSON.parse(raw || "{}");
  } catch (err) {
    console.error("Memory load error:", err);
    return {};
  }
}

function saveAllMemory(memoryObj) {
  try {
    fs.writeFileSync(MEMORY_FILE, JSON.stringify(memoryObj, null, 2));
  } catch (err) {
    console.error("Memory save error:", err);
  }
}

function getUserMemory(userId) {
  const all = loadAllMemory();
  if (!all[userId]) {
    all[userId] = { goals: [], preferences: [], notes: [] };
    saveAllMemory(all);
  }
  return all[userId];
}

function addMemory(userId, bucket, value) {
  const all = loadAllMemory();
  if (!all[userId]) all[userId] = { goals: [], preferences: [], notes: [] };
  if (!all[userId][bucket]) all[userId][bucket] = [];

  all[userId][bucket].push(value);
  saveAllMemory(all);
}

function clearMemory(userId) {
  const all = loadAllMemory();
  delete all[userId];
  saveAllMemory(all);
}

// Helper: format memory cleanly
function formatMemory(mem) {
  const goals = (mem.goals || []).map((x) => `â€¢ ${x}`).join("\n") || "â€”";
  const prefs = (mem.preferences || []).map((x) => `â€¢ ${x}`).join("\n") || "â€”";
  const notes = (mem.notes || []).map((x) => `â€¢ ${x}`).join("\n") || "â€”";

  return `Goals:\n${goals}\n\nPreferences:\n${prefs}\n\nNotes:\n${notes}`;
}

// =====================
// ROUTES
// =====================
app.get("/", (_req, res) => res.status(200).send("MoltbÃ¸t is alive âœ…"));
app.get("/telegram", (_req, res) =>
  res.status(200).send("Telegram webhook endpoint âœ… (POST expected)")
);

// =====================
// TELEGRAM WEBHOOK
// =====================
app.post("/telegram", async (req, res) => {
  // Always ACK Telegram immediately so it doesn't retry
  res.sendStatus(200);

  try {
    const message = req.body?.message;
    if (!message) return;

    const chatId = String(message.chat?.id || "");
    const text = message.text?.trim();
    if (!chatId || !text) return;

    const lower = text.toLowerCase();

    // ---------- COMMANDS ----------
    if (lower === "/start") {
      await sendTelegram(chatId, "ğŸ‘‹ Welcome to MoltbÃ¸t! Iâ€™m alive and listening.");
      return;
    }

    if (lower === "/help") {
      await sendTelegram(
        chatId,
        `ğŸ“– Commands:
â€¢ /start â€“ start the bot
â€¢ /help â€“ see commands
â€¢ /status â€“ check bot status
â€¢ remember: <text> â€“ save memory (goes to Notes)
â€¢ remember goal: <text> â€“ save a goal
â€¢ remember pref: <text> â€“ save a preference
â€¢ recall â€“ show everything remembered
â€¢ forget â€“ clear all memory for this chat
â€¢ /log <text> â€“ log a message
Or just ask me anything ğŸ™‚`
      );
      return;
    }

    if (lower === "/status") {
      await sendTelegram(
        chatId,
        `ğŸŸ¢ MoltbÃ¸t Status:
â€¢ Server: OK
â€¢ Model: ${OPENAI_MODEL}
â€¢ Memory file: ${MEMORY_FILE}
â€¢ Time: ${new Date().toISOString()}`
      );
      return;
    }

    if (lower.startsWith("/log ")) {
      const logText = text.slice(5).trim();
      console.log("USER LOG:", { chatId, logText });
      await sendTelegram(chatId, `ğŸ“ Logged: "${logText}"`);
      return;
    }

    // ---------- MEMORY COMMANDS ----------
    // remember goal: ...
    if (lower.startsWith("remember goal:")) {
      const content = text.slice("remember goal:".length).trim();
      if (!content) {
        await sendTelegram(chatId, "âš ï¸ Usage: remember goal: <text>");
        return;
      }
      addMemory(chatId, "goals", content);
      await sendTelegram(chatId, "ğŸ§  Saved to Goals.");
      return;
    }

    // remember pref: ...
    if (lower.startsWith("remember pref:") || lower.startsWith("remember preference:")) {
      const prefix = lower.startsWith("remember pref:")
        ? "remember pref:"
        : "remember preference:";
      const content = text.slice(prefix.length).trim();
      if (!content) {
        await sendTelegram(chatId, "âš ï¸ Usage: remember pref: <text>");
        return;
      }
      addMemory(chatId, "preferences", content);
      await sendTelegram(chatId, "ğŸ§  Saved to Preferences.");
      return;
    }

    // remember: ... (default = notes)
    if (lower.startsWith("remember:")) {
      const content = text.slice("remember:".length).trim();
      if (!content) {
        await sendTelegram(chatId, "âš ï¸ Usage: remember: <text>");
        return;
      }
      addMemory(chatId, "notes", content);
      await sendTelegram(chatId, "ğŸ§  Saved to Notes.");
      return;
    }

    // recall
    if (lower === "recall") {
      const mem = getUserMemory(chatId);
      await sendTelegram(chatId, `ğŸ§  Hereâ€™s what I remember:\n\n${formatMemory(mem)}`);
      return;
    }

    // forget
    if (lower === "forget") {
      clearMemory(chatId);
      await sendTelegram(chatId, "ğŸ§½ Memory cleared for this chat.");
      return;
    }

    // ---------- AI CHAT ----------
    const mem = getUserMemory(chatId);
    const aiReply = await askOpenAI(text, mem);
    await sendTelegram(chatId, aiReply);
  } catch (err) {
    console.error("Telegram handler error:", err);
  }
});

// =====================
// OPENAI CALL
// =====================
async function askOpenAI(userText, mem) {
  try {
    const memoryContext = formatMemory(mem);

    const response = await openai.chat.completions.create({
      model: OPENAI_MODEL,
      messages: [
        {
          role: "system",
          content:
            `You are MoltbÃ¸t, a helpful Telegram assistant.\n\n` +
            `User memory (trusted):\n${memoryContext}\n\n` +
            `Use the memory when itâ€™s relevant. If memory is missing, ask a question instead of guessing.`,
        },
        { role: "user", content: userText },
      ],
      temperature: 0.7,
    });

    return response.choices?.[0]?.message?.content?.trim() || "â€¦";
  } catch (err) {
    const status = err?.status || err?.response?.status;
    const data = err?.response?.data || err?.message;
    console.error("OpenAI request failed:", { status, data, model: OPENAI_MODEL });

    return `âš ï¸ OpenAI error (${status || "unknown"}). Check Railway logs.`;
  }
}

// =====================
// TELEGRAM SEND
// =====================
async function sendTelegram(chatId, text) {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

  const resp = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: chatId,
      text,
      disable_web_page_preview: true,
    }),
  });

  if (!resp.ok) {
    const body = await resp.text().catch(() => "");
    console.error("Telegram sendMessage failed:", resp.status, body);
  }
}

// =====================
// START SERVER
// =====================
app.listen(Number(PORT), () => {
  console.log(`ğŸš€ MoltbÃ¸t running on port ${PORT}`);
  console.log(`âœ… Using model: ${OPENAI_MODEL}`);
  console.log(`âœ… Memory file: ${MEMORY_FILE}`);
});
